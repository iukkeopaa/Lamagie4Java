## 集群的原理

### 数据分片



Redis 集群采用哈希槽（Hash Slot）的方式进行数据分片，将整个数据库的键空间划分为 16384 个哈希槽。每个哈希槽可以理解为一个逻辑上的存储单元，集群中的每个节点负责处理一部分哈希槽。



- **哈希槽分配**：在创建 Redis 集群时，需要手动或自动地将这 16384 个哈希槽分配给各个节点。例如，一个包含 3 个节点的集群，可能节点 A 负责处理 0 - 5460 号哈希槽，节点 B 负责处理 5461 - 10922 号哈希槽，节点 C 负责处理 10923 - 16383 号哈希槽。
- **键的映射**：当客户端向集群中写入或读取一个键时，Redis 会使用 CRC16 算法对键进行哈希计算，得到一个 16 位的哈希值，然后将这个哈希值对 16384 取模，得到该键对应的哈希槽编号。根据这个编号，就可以确定该键应该存储在哪个节点上。例如，计算得到键 `user:1` 对应的哈希槽编号为 3000，而节点 A 负责处理 0 - 5460 号哈希槽，那么该键就会被存储在节点 A 上。

### 节点通信



Redis 集群中的节点之间通过 Gossip 协议进行通信，该协议主要用于节点发现、故障检测和哈希槽信息的传播。



- **节点发现**：当一个新节点加入集群时，它会向其他已知节点发送 `MEET` 消息，通知其他节点自己的存在。其他节点收到 `MEET` 消息后，会将该新节点添加到自己的节点列表中，并向它发送 `PING` 消息进行确认。
- **故障检测**：节点之间会定期互相发送 `PING` 消息，以检测对方是否正常工作。如果一个节点在一定时间内没有收到另一个节点的响应，会将其标记为 `PFAIL`（可能故障）状态。当多个节点都将某个节点标记为 `PFAIL` 时，会将其标记为 `FAIL`（确定故障）状态，并将该信息传播给其他节点。
- **哈希槽信息传播**：当哈希槽的分配发生变化时（如节点加入、退出或重新分配哈希槽），节点会通过 Gossip 协议将新的哈希槽信息传播给其他节点，确保所有节点都能了解最新的哈希槽分配情况。

### 主从复制



为了提高集群的可用性和容错能力，Redis 集群采用主从复制机制。每个主节点都可以有一个或多个从节点，从节点会复制主节点的数据。



- **数据同步**：当一个从节点连接到主节点时，会向主节点发送 `PSYNC` 命令，请求进行数据同步。主节点会将自己的当前数据快照发送给从节点，从节点接收并加载这些数据。之后，主节点会将新的写操作发送给从节点，从节点执行这些操作，以保持与主节点的数据一致。
- **故障转移**：当一个主节点发生故障时，集群会自动进行故障转移。从该主节点的从节点中选举出一个新的主节点，继续处理该主节点负责的哈希槽。选举过程基于 Raft 算法，从节点通过投票的方式选出新的主节点。

### 客户端与集群的交互



客户端可以直接连接到 Redis 集群中的任意节点，向其发送命令。当客户端发送的命令涉及的键对应的哈希槽不在该节点负责的范围内时，该节点会返回一个 `MOVED` 或 `ASK` 错误，指示客户端将请求重定向到负责该哈希槽的节点。



- **MOVED 错误**：当客户端第一次访问某个键时，如果该键对应的哈希槽不在当前连接的节点上，当前节点会返回 `MOVED` 错误，同时告知客户端负责该哈希槽的节点的地址。客户端需要重新连接到该节点，并再次发送请求。
- **ASK 错误**：在哈希槽迁移过程中，当客户端访问的键对应的哈希槽正在从一个节点迁移到另一个节点时，当前节点会返回 `ASK` 错误，指示客户端临时将请求发送到目标节点。客户端在处理完该请求后，后续请求仍会发送到原来的节点，直到哈希槽迁移完成。


## redis集群会有写操作丢失吗

### 网络分区导致写操作丢失



- **原理**：当网络出现分区时，Redis 集群会被分割成多个独立的子网，部分节点之间无法正常通信。此时，如果客户端向处于少数派子网中的主节点写入数据，而该子网中的主节点无法与多数派子网中的节点进行通信，当网络分区恢复后，可能会导致这些写操作丢失。
- **示例**：假设一个 Redis 集群有 5 个主节点（A、B、C、D、E），正常情况下它们相互通信并协同工作。当网络发生分区，将集群分成两个子网，子网 1 包含节点 A、B、C，子网 2 包含节点 D、E。如果客户端此时向子网 2 中的主节点 D 写入数据，由于子网 2 是少数派，在网络分区恢复后，集群会以多数派子网 1 的状态为准，子网 2 中主节点 D 上的写操作可能会被丢弃，从而造成写操作丢失。

### 异步复制导致写操作丢失



- **原理**：Redis 集群采用主从复制机制，主节点将写操作异步复制给从节点。这意味着主节点在收到客户端的写请求并返回成功响应后，并不会等待所有从节点都完成复制操作。如果在主节点将写操作复制给从节点之前，主节点发生故障，那么这些还未复制到从节点的写操作就会丢失。
- **示例**：客户端向主节点发送一个写操作，主节点处理该请求并返回成功响应给客户端，但此时主节点还没来得及将该写操作复制给从节点就突然崩溃了。随后，集群进行故障转移，选举出一个从节点作为新的主节点，由于新主节点没有收到之前未复制的写操作，这部分数据就丢失了。

### 故障转移期间的写操作丢失



- **原理**：当主节点发生故障时，Redis 集群会进行故障转移，选举一个从节点作为新的主节点。在故障转移过程中，可能会有短暂的时间窗口，期间客户端的写操作可能会丢失。例如，在原主节点故障到新主节点完全接管服务的这段时间内，如果客户端向原主节点写入数据，而这些数据没有同步到新主节点，就会造成写操作丢失。
- **示例**：主节点 M 突然故障，集群开始进行故障转移，选举从节点 S 作为新的主节点。在这个过程中，客户端向故障的主节点 M 发送了一个写操作，由于 M 已经无法正常工作，且该写操作没有同步到从节点 S 上，当 S 成为新主节点后，这个写操作就丢失了。

### 配置参数不合理导致写操作丢失



- **原理**：Redis 有一些配置参数会影响数据的持久化和复制策略，如果配置不合理，也可能导致写操作丢失。例如，`appendfsync` 参数用于控制 AOF（Append - Only File）持久化的同步频率，如果设置为 `no`，表示不进行同步，数据只在内存中，一旦服务器崩溃，未同步到磁盘的写操作就会丢失。
- **示例**：将 `appendfsync` 设置为 `no`，在服务器突然断电的情况下，内存中的写操作还未同步到磁盘，就会造成数据丢失。


## redis集群方案什么情况下会导致整个集群不可用

### 节点故障



- 多数主节点故障
    - Redis 集群采用主从复制架构，每个主节点负责一部分哈希槽。当超过半数的主节点发生故障时，集群将无法正常工作。因为 Redis 集群需要多数主节点达成一致来进行一些关键操作，如哈希槽的分配和迁移等。一旦多数主节点不可用，集群就无法确定哪些哈希槽是可用的，从而导致整个集群不可用。
    - 例如，一个包含 5 个主节点的集群，当 3 个或 3 个以上主节点故障时，集群就会陷入不可用状态。
- 关键节点故障
    - 即使没有达到多数主节点故障的情况，如果某个负责大量关键哈希槽的主节点发生故障，且该主节点没有可用的从节点进行故障转移，也可能导致部分服务无法正常提供，当影响范围较大时，可能会使整个集群看起来不可用。
    - 比如，某个主节点负责处理用户登录相关的哈希槽，该节点故障且无可用从节点接替，那么用户登录功能将无法使用，严重时可能影响整个业务流程，导致集群表现为不可用。

### 网络分区



- 分区导致多数派节点失联
    - 当网络发生分区，将集群分割成多个子网，且某个子网中的节点数量不构成多数派时，这个子网中的节点将无法与多数派节点进行通信。如果多数派节点所在的子网出现故障或无法正常工作，那么整个集群将无法达成一致，无法进行正常的操作，从而导致集群不可用。
    - 例如，一个 7 节点的集群被网络分区成一个包含 2 个节点的子网和一个包含 5 个节点的子网，若包含 5 个节点的子网出现故障，由于这是多数派节点，集群将无法正常运行。
- 分区导致哈希槽信息不一致
    - 网络分区可能会导致不同子网中的节点对哈希槽的分配信息产生不一致。当网络分区恢复后，节点之间需要进行哈希槽信息的同步和修复，如果这个过程中出现问题，可能会导致部分哈希槽无法正常访问，进而影响整个集群的可用性。

### 配置错误



- 哈希槽分配错误
    - 在创建或重新配置 Redis 集群时，如果哈希槽的分配出现错误，例如某个哈希槽被重复分配给多个节点，或者部分哈希槽没有被分配到任何节点，会导致集群无法正常处理这些哈希槽对应的键值对，严重时会使整个集群不可用。
- 节点通信配置错误
    - 节点之间的通信配置（如 IP 地址、端口号等）错误，会导致节点之间无法正常通信。节点无法交换哈希槽信息、进行故障检测和主从复制等操作，最终导致集群无法正常工作。

### 资源耗尽



- 内存资源耗尽
    - 当集群中的节点内存资源耗尽时，Redis 可能会触发内存淘汰策略。如果内存压力过大，淘汰策略无法及时释放足够的内存，节点可能会出现卡顿甚至崩溃的情况。多个节点同时出现这种情况时，会导致整个集群不可用。
- 磁盘 I/O 资源耗尽
    - 如果集群使用了持久化机制（如 AOF 或 RDB），当磁盘 I/O 资源耗尽时，数据的写入和读取操作会变得非常缓慢，甚至出现阻塞。这会影响到集群的正常运行，严重时会导致整个集群不可用。

### 软件或硬件故障



- Redis 软件版本不兼容或存在 Bug
    - 使用不兼容的 Redis 软件版本，或者软件本身存在严重的 Bug，可能会导致集群出现各种异常情况，如节点崩溃、数据丢失等，最终使整个集群不可用。
- 硬件故障
    - 服务器硬件（如硬盘、内存、网络设备等）出现故障，会直接影响到节点的正常运行。如果多个节点同时受到硬件故障的影响，会导致整个集群不可用