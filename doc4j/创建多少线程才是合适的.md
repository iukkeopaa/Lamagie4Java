

创建多少线程合适，要看多线程具体的应用场景。我们的程序一般都是 CPU 计算和 I/O 操
作交叉执行的，由于 I/O 设备的速度相对于 CPU 来说都很慢，所以大部分情况下，I/O 操
作执行的时间相对于 CPU 计算来说都非常长，这种场景我们一般都称为 I/O 密集型计算；
和 I/O 密集型计算相对的就是 CPU 密集型计算了，CPU 密集型计算大部分场景下都是纯
CPU 计算。I/O 密集型程序和 CPU 密集型程序，计算最佳线程数的方法是不同的。

下面我们对这两个场景分别说明。
对于 CPU 密集型计算，多线程本质上是提升多核 CPU 的利用率，所以对于一个 4 核的
CPU，每个核一个线程，理论上创建 4 个线程就可以了，再多创建线程也只是增加线程切
换的成本。所以，对于 CPU 密集型的计算场景，理论上“线程的数量 =CPU 核数”就是
最合适的。不过在工程上，线程的数量一般会设置为“CPU 核数 +1”，这样的话，当线
程因为偶尔的内存页失效或其他原因导致阻塞时，这个额外的线程可以顶上，从而保证
CPU 的利用率。
对于 I/O 密集型的计算场景，比如前面我们的例子中，如果 CPU 计算和 I/O 操作的耗时是
1:1，那么 2 个线程是最合适的。如果 CPU 计算和 I/O 操作的耗时是 1:2，那多少个线程
合适呢？是 3 个线程，如下图所示：CPU 在 A、B、C 三个线程之间切换，对于线程 A，
当 CPU 从 B、C 切换回来时，线程 A 正好执行完 I/O 操作。这样 CPU 和 I/O 设备的利用
率都达到了 100%。

通过上面这个例子，我们会发现，对于 I/O 密集型计算场景，最佳的线程数是与程序中
CPU 计算和 I/O 操作的耗时比相关的，我们可以总结出这样一个公式：
最佳线程数 =1 +（I/O 耗时 / CPU 耗时）

我们令 R=I/O 耗时 / CPU 耗时，综合上图，可以这样理解：当线程 A 执行 IO 操作时，另
外 R 个线程正好执行完各自的 CPU 计算。这样 CPU 的利用率就达到了 100%。
不过上面这个公式是针对单核 CPU 的，至于多核 CPU，也很简单，只需要等比扩大就可以
了，计算公式如下：
最佳线程数 =CPU 核数 * [ 1 +（I/O 耗时 / CPU 耗时）]


### 线程封闭

方法里的局部变量，因为不会和其他线程共享，所以没有并发问题，这个思路很好，已经成
为解决并发问题的一个重要技术，同时还有个响当当的名字叫做线程封闭，比较官方的解释
是：仅在单线程内访问数据。由于不存在共享，所以即便不同步也不会有并发问题，性能杠
杠的。
采用线程封闭技术的案例非常多，例如从数据库连接池里获取的连接 Connection，在
JDBC 规范里并没有要求这个 Connection 必须是线程安全的。数据库连接池通过线程封闭
技术，保证一个 Connection 一旦被一个线程获取之后，在这个线程关闭 Connection 之
前的这段时间里，不会再分配给其他线程，从而保证了 Connection 不会有并发问题。